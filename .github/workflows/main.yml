name: Build EOL Factory App (Windows)

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags
  workflow_dispatch:  # Manual trigger
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: true
        type: boolean
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: false
        default: ''
        type: string

permissions:
  contents: write  # Required for creating releases

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Clean cache and node_modules
        shell: bash
        run: |
          echo "Cleaning electron-builder cache..."
          rm -rf ~/.cache/electron-builder
          rm -rf ~/AppData/Local/electron-builder/Cache || true
          echo "Cache cleaned"
      
      - name: Update version in package.json
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
          else
            TAG="${{ github.event.inputs.release_tag }}"
            if [ -z "$TAG" ]; then
              VERSION="1.0.0"
            else
              VERSION="${TAG#v}"
            fi
          fi
          echo "Setting version to: $VERSION"
          npm version $VERSION --no-git-tag-version --allow-same-version
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for Windows
        run: npm run build:win
        env:
          DEBUG: electron-builder
      
      - name: List build output
        if: always()
        shell: bash
        run: |
          echo "=== Build output ==="
          ls -lh dist/ || echo "No dist folder"
      
      - name: Upload Windows artifacts (directory)
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/*.exe
          retention-days: 30
          if-no-files-found: warn

  create-release:
    if: |
      always() &&
      (startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.create_release == true)) &&
      needs.build-windows.result == 'success'
    needs: [build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for changelog generation
      
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./windows-build
        continue-on-error: true
      
      - name: Get release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            TAG="${{ github.event.inputs.release_tag }}"
            if [ -z "$TAG" ]; then
              TAG="v$(date +'%Y.%m.%d-%H%M')"
            fi
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          fi
      
      - name: Auto-detect previous version
        id: detect_version
        run: |
          CURRENT_TAG="${{ steps.get_tag.outputs.tag }}"
          LATEST_TAG=$(git tag --sort=-version:refname | grep -v "^${CURRENT_TAG}$" | head -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "previous_version=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Auto-detected previous version: $LATEST_TAG"
      
      - name: List downloaded artifacts
        run: |
          echo "=== Windows Build ==="
          ls -lh ./windows-build/
          echo ""
      
      - name: Generate release notes
        run: |
          CURRENT_TAG="${{ steps.get_tag.outputs.tag }}"
          PREVIOUS_VERSION="${{ steps.detect_version.outputs.previous_version }}"
          
          # Start with main title
          echo "## ðŸ­ Nube iO EOL Factory Testing Toolkit ${CURRENT_TAG}" > release_notes.md
          echo "" >> release_notes.md
          echo "Complete factory testing solution for NubeIO devices: Flash, Test, Monitor & Provision" >> release_notes.md
          echo "" >> release_notes.md
          
          # Generate commit-based changelog
          echo "### ðŸ“ Changes Since ${PREVIOUS_VERSION}" >> release_notes.md
          echo "" >> release_notes.md
          
          # Get commits since previous version
          if [ "$PREVIOUS_VERSION" != "$(git rev-list --max-parents=0 HEAD)" ]; then
            git log --pretty=format:"- %s (%h)" ${PREVIOUS_VERSION}..HEAD --reverse >> release_notes.md
          else
            git log --pretty=format:"- %s (%h)" --reverse >> release_notes.md
          fi
          echo "" >> release_notes.md
          echo "" >> release_notes.md
          
          # Add download information
          cat >> release_notes.md <<'EOF'
          ## ðŸ“¦ Downloads
          
          ### Windows (64-bit)
          - **Portable Executable**: `Nube-iO-EOL-Factory-${CURRENT_TAG}.exe` - Standalone application (no installation required)
          
          ## ðŸš€ Quick Start
          
          **Windows:**
          1. Download the `.exe` file
          2. Double-click to run (no installation needed)
          3. Connect your NubeIO device via USB
          4. Start testing!
          
          ## âœ¨ Features
          
          - **Factory Testing Module**: Automated testing for NubeIO devices
            - Micro Edge (Gen 1)
            - ZC-LCD, ZC-Controller, ACB-M, Droplet (Gen 2)
          - **Serial Communication**: AT command protocol for device testing
          - **Auto-Connect**: Automatic device detection and workflow
          - **ESP32 Flasher**: Native firmware flashing with partition support
          - **STM32 Flasher**: OpenOCD-based programming via SWD
          - **Device Provisioning**: WiFi configuration and NVS provisioning
          - **Label Printing**: Integrated Brother label printer support
          - **Serial Console**: Real-time device monitoring
          - **UDP Logger**: Capture and analyze device logs
          - **Fleet Monitoring**: MQTT-based device monitoring
          
          ## ðŸ§ª Testing Capabilities
          
          - WiFi connectivity validation
          - LoRa communication testing (ACB-M)
          - Hardware component verification
          - Firmware version checking
          - Automated test workflows
          - Test result tracking and reporting
          
          ## â„¹ï¸ Build Information
          
          - **Version:** ${CURRENT_TAG}
          - **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Commit:** ${{ github.sha }}
          - **Branch:** ${{ github.ref_name }}
          - **Changes Since:** ${PREVIOUS_VERSION}
          
          ## ðŸ› ï¸ System Requirements
          
          **Windows:**
          - Windows 10 or later (64-bit)
          - USB port for device connection
          - .NET Framework 4.6 or later (for label printing)
          
          ## ðŸ“‹ What's Included
          
          - **Factory Testing Suite**: Complete EOL testing workflow
          - **ESP32 Tools**: Native esptool integration with binaries
          - **STM32 Tools**: OpenOCD binaries for programming
          - **Serial Port Support**: Full serial communication stack
          - **Provisioning Tools**: NVS partition generation and flashing
          - **Label Printer**: Python-based Brother label printer integration
          - **Test Automation**: Auto-connect and auto-next device workflows
          
          ## ðŸ­ Supported Devices
          
          **Generation 1:**
          - Micro Edge
          
          **Generation 2:**
          - ZC-LCD
          - ZC-Controller
          - ACB-M
          - Droplet
          
          ---
          
          ðŸ¤– **Generated automatically from commits**
          
          ðŸ“ **Need help?** Check our documentation
          
          ðŸ› **Found an issue?** Please report it on GitHub Issues
          
          â­ **Like this tool?** Give us a star on GitHub!
          EOF
          
          # Replace ${CURRENT_TAG} in the markdown
          sed -i "s/\${CURRENT_TAG}/${CURRENT_TAG}/g" release_notes.md
          
          echo "=== Generated Release Notes ==="
          cat release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Nube iO EOL Factory ${{ steps.get_tag.outputs.tag }}
          body_path: release_notes.md
          files: |
            ./windows-build/*.exe
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
